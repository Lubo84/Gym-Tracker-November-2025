import React, { useState, useEffect } from 'react';
import { Dumbbell, Save, ChevronLeft, TrendingUp, RotateCcw, Edit2, X, Check } from 'lucide-react';

// --- Default Program Data ---
const DEFAULT_PROGRAM = {
  upperA: {
    id: 'upperA',
    title: "Upper Body A",
    subtitle: "Strength & Tension Focus",
    color: "bg-blue-600",
    exercises: [
      { id: 'bench', name: 'Flat Bench Press', sets: 3, range: '6-8', note: 'Primary chest builder. 2 RIR.' },
      { id: 'row', name: 'Chest Supported Row', sets: 3, range: '8-10', note: 'Strict form. No swinging.' },
      { id: 'ohp', name: 'Overhead Press', sets: 3, range: '8-10', note: 'Standing or seated.' },
      { id: 'pullup', name: 'Weighted Pull-Up/Lat Pull', sets: 3, range: '8-10', note: 'Drive elbows to hips.' },
      { id: 'incline_curl', name: 'Incline DB Curl', sets: 3, range: '10-12', note: 'Full stretch at bottom.' },
      { id: 'skull', name: 'Skullcrushers', sets: 3, range: '10-12', note: 'Elbows tucked.' },
    ]
  },
  lowerA: {
    id: 'lowerA',
    title: "Lower Body A",
    subtitle: "Quad Focus",
    color: "bg-red-600",
    exercises: [
      { id: 'squat', name: 'High Bar Squat', sets: 3, range: '6-8', note: 'Deep flexion.' },
      { id: 'rdl', name: 'Romanian Deadlift', sets: 3, range: '8-10', note: 'Push hips back.' },
      { id: 'legpress', name: 'Leg Press', sets: 3, range: '10-12', note: 'Feet low/close. Constant tension.' },
      { id: 'legext', name: 'Leg Extension', sets: 3, range: '12-15', note: '1s hold at top.' },
      { id: 'calf_stand', name: 'Standing Calf Raise', sets: 4, range: '10-15', note: 'Slow eccentric.' },
      { id: 'abs_cable', name: 'Cable Crunch', sets: 3, range: '10-15', note: 'Flex spine.' },
    ]
  },
  upperB: {
    id: 'upperB',
    title: "Upper Body B",
    subtitle: "Hypertrophy & Width",
    color: "bg-indigo-600",
    exercises: [
      { id: 'incline_bench', name: 'Incline DB Press', sets: 3, range: '8-12', note: '30 degree angle.' },
      { id: 'lat_iso', name: 'Single Arm Lat Pulldown', sets: 3, range: '10-12', note: 'Deep stretch.' },
      { id: 'lat_raise', name: 'Cable Lateral Raise', sets: 4, range: '12-15', note: 'Constant tension.' },
      { id: 'fly', name: 'Pec Deck/Cable Fly', sets: 3, range: '12-15', note: 'Focus on squeeze.' },
      { id: 'tri_push', name: 'Tricep Pushdown', sets: 3, range: '12-15', note: 'Elbows pinned.' },
      { id: 'hammer', name: 'Hammer Curls', sets: 3, range: '10-12', note: 'For forearm thickness.' },
    ]
  },
  lowerB: {
    id: 'lowerB',
    title: "Lower Body B",
    subtitle: "Hinge & Posterior",
    color: "bg-orange-600",
    exercises: [
      { id: 'legcurl', name: 'Seated Leg Curl', sets: 3, range: '10-12', note: 'Pre-fatigue hamstrings.' },
      { id: 'deadlift', name: 'Deadlift', sets: 3, range: '5-8', note: 'Reset every rep.' },
      { id: 'split_squat', name: 'Bulgarian Split Squat', sets: 3, range: '8-12', note: 'Lean forward for glutes.' },
      { id: 'legext_high', name: 'Leg Extension', sets: 3, range: '15-20', note: 'Burnout sets.' },
      { id: 'calf_seat', name: 'Seated Calf Raise', sets: 3, range: '15-20', note: 'Targets soleus.' },
      { id: 'plank', name: 'Plank/Ab Wheel', sets: 3, range: 'Failure', note: 'Core stability.' },
    ]
  }
};

const App = () => {
  const [view, setView] = useState('home');
  const [activeWorkoutId, setActiveWorkoutId] = useState(null);
  
  // Data State
  const [program, setProgram] = useState(DEFAULT_PROGRAM);
  const [logs, setLogs] = useState({}); 
  const [currentSession, setCurrentSession] = useState({});
  const [showResetConfirm, setShowResetConfirm] = useState(false);

  // Editing State
  const [editingExerciseId, setEditingExerciseId] = useState(null);
  const [editForm, setEditForm] = useState({ sets: 3, range: '', note: '' });

  // Load Data on Mount
  useEffect(() => {
    const savedLogs = localStorage.getItem('gym_logs_v2');
    const savedProgram = localStorage.getItem('gym_program_custom');
    
    if (savedLogs) setLogs(JSON.parse(savedLogs));
    if (savedProgram) setProgram(JSON.parse(savedProgram));
  }, []);

  // --- Helpers ---

  const getLastLog = (exerciseId, setIndex) => {
    if (!logs[exerciseId] || logs[exerciseId].length === 0) return null;
    const history = logs[exerciseId].sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastSession = history[0];
    if (!lastSession || !lastSession.sets[setIndex]) return null;
    return lastSession.sets[setIndex];
  };

  const getPR = (exerciseId) => {
    if (!logs[exerciseId]) return null;
    let maxWeight = 0;
    logs[exerciseId].forEach(session => {
      session.sets.forEach(set => {
        if (parseFloat(set.weight) > maxWeight) maxWeight = parseFloat(set.weight);
      });
    });
    return maxWeight > 0 ? maxWeight : null;
  };

  // --- Actions ---

  const handleStartWorkout = (id) => {
    setActiveWorkoutId(id);
    const skeleton = {};
    program[id].exercises.forEach(ex => {
      skeleton[ex.id] = Array(ex.sets).fill({ weight: '', reps: '' });
    });
    setCurrentSession(skeleton);
    setView('workout');
  };

  const handleInputChange = (exId, setIndex, field, value) => {
    setCurrentSession(prev => {
      // If sets changed dynamically, ensure array exists
      const currentSets = prev[exId] || [];
      const newSets = [...currentSets];
      
      // Pad array if needed (in case user increased sets mid-workout)
      while (newSets.length <= setIndex) {
        newSets.push({ weight: '', reps: '' });
      }
      
      newSets[setIndex] = { ...newSets[setIndex], [field]: value };
      return { ...prev, [exId]: newSets };
    });
  };

  const handleFinishWorkout = () => {
    const date = new Date().toISOString();
    const newLogs = { ...logs };

    Object.keys(currentSession).forEach(exId => {
      if (!newLogs[exId]) newLogs[exId] = [];
      const validSets = currentSession[exId].filter(s => s && (s.weight || s.reps));
      if (validSets.length > 0) {
        newLogs[exId].unshift({ date: date, sets: validSets });
      }
    });

    setLogs(newLogs);
    localStorage.setItem('gym_logs_v2', JSON.stringify(newLogs));
    setView('home');
    setActiveWorkoutId(null);
    setCurrentSession({});
  };

  const handleResetData = () => {
    localStorage.removeItem('gym_logs_v2');
    localStorage.removeItem('gym_program_custom');
    setLogs({});
    setProgram(DEFAULT_PROGRAM);
    setShowResetConfirm(false);
  };

  // --- Customization Logic ---

  const startEditing = (ex) => {
    setEditingExerciseId(ex.id);
    setEditForm({ sets: ex.sets, range: ex.range, note: ex.note });
  };

  const saveEdit = (workoutId, exId) => {
    const newProgram = { ...program };
    const exerciseIndex = newProgram[workoutId].exercises.findIndex(e => e.id === exId);
    
    if (exerciseIndex > -1) {
      newProgram[workoutId].exercises[exerciseIndex] = {
        ...newProgram[workoutId].exercises[exerciseIndex],
        sets: parseInt(editForm.sets),
        range: editForm.range,
        note: editForm.note
      };
      
      setProgram(newProgram);
      localStorage.setItem('gym_program_custom', JSON.stringify(newProgram));
      setEditingExerciseId(null);

      // Adjust current session state if sets changed
      const currentSets = currentSession[exId] || [];
      let newSessionSets = [...currentSets];
      const newSetCount = parseInt(editForm.sets);

      if (newSessionSets.length < newSetCount) {
        // Add sets
        const diff = newSetCount - newSessionSets.length;
        for(let i=0; i<diff; i++) newSessionSets.push({weight:'', reps:''});
      } else if (newSessionSets.length > newSetCount) {
        // Remove sets
        newSessionSets = newSessionSets.slice(0, newSetCount);
      }
      setCurrentSession(prev => ({...prev, [exId]: newSessionSets}));
    }
  };

  // --- Components ---

  const HomeScreen = () => (
    <div className="p-4 max-w-md mx-auto space-y-6">
      <header className="mb-8">
        <h1 className="text-3xl font-bold text-slate-800">Hypertrophy Log</h1>
        <p className="text-slate-500">Upper/Lower • Double Progression</p>
      </header>

      <div className="grid gap-4">
        {Object.values(program).map(workout => (
          <button
            key={workout.id}
            onClick={() => handleStartWorkout(workout.id)}
            className={`${workout.color} text-white p-5 rounded-2xl shadow-lg hover:opacity-90 transition-all text-left flex justify-between items-center group`}
          >
            <div>
              <h3 className="text-xl font-bold">{workout.title}</h3>
              <p className="text-white/80 text-sm">{workout.subtitle}</p>
            </div>
            <Dumbbell className="w-6 h-6 opacity-50 group-hover:opacity-100 transition-opacity" />
          </button>
        ))}
      </div>

      <div className="pt-8 border-t border-slate-200 mt-8">
        <button 
          onClick={() => setShowResetConfirm(true)}
          className="w-full py-3 text-slate-400 text-sm flex items-center justify-center gap-2 hover:text-red-500 transition-colors"
        >
          <RotateCcw size={14} /> Reset Logs & Customizations
        </button>
      </div>

      {showResetConfirm && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white p-6 rounded-xl max-w-xs w-full">
            <h3 className="font-bold text-lg mb-2">Reset Everything?</h3>
            <p className="text-slate-600 mb-4 text-sm">This will delete all workout history and revert any customizations to the default program.</p>
            <div className="flex gap-2">
              <button onClick={() => setShowResetConfirm(false)} className="flex-1 py-2 bg-slate-100 rounded-lg font-medium">Cancel</button>
              <button onClick={handleResetData} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-medium">Delete</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );

  const WorkoutScreen = () => {
    const workout = program[activeWorkoutId];
    
    return (
      <div className="pb-32 bg-slate-50 min-h-screen">
        <div className={`sticky top-0 z-20 ${workout.color} text-white px-4 py-4 shadow-md flex items-center gap-4`}>
          <button onClick={() => setView('home')} className="p-1 hover:bg-white/20 rounded-full">
            <ChevronLeft size={24} />
          </button>
          <div>
            <h2 className="font-bold text-lg leading-none">{workout.title}</h2>
            <span className="text-xs opacity-80">{workout.subtitle}</span>
          </div>
        </div>

        <div className="p-4 space-y-6 max-w-md mx-auto">
          {workout.exercises.map((ex) => {
            const pr = getPR(ex.id);
            const isEditing = editingExerciseId === ex.id;
            
            return (
              <div key={ex.id} className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden relative">
                
                {/* Exercise Header */}
                <div className="p-4 border-b border-slate-100 bg-slate-50/50">
                  {!isEditing ? (
                    <>
                      <div className="flex justify-between items-start mb-1">
                        <h3 className="font-bold text-slate-800 text-lg pr-8">{ex.name}</h3>
                        <button onClick={() => startEditing(ex)} className="text-slate-400 hover:text-blue-600 p-1">
                          <Edit2 size={14} />
                        </button>
                      </div>
                      <div className="flex justify-between items-center text-xs">
                        <div className="text-slate-500 space-x-2">
                           <span className="font-semibold bg-slate-200 px-1.5 py-0.5 rounded">{ex.sets} sets</span>
                           <span className="font-semibold bg-slate-200 px-1.5 py-0.5 rounded">{ex.range} reps</span>
                           <span className="italic text-slate-400">{ex.note}</span>
                        </div>
                        {pr && (
                          <span className="text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full flex items-center gap-1 font-bold">
                            <TrendingUp size={10} /> {pr}kg
                          </span>
                        )}
                      </div>
                    </>
                  ) : (
                    /* Edit Mode */
                    <div className="space-y-3 animate-in fade-in">
                      <div className="flex justify-between items-center">
                        <h3 className="font-bold text-slate-800">{ex.name}</h3>
                        <div className="flex gap-2">
                          <button onClick={() => setEditingExerciseId(null)} className="p-1 text-slate-400 hover:bg-slate-100 rounded"><X size={18}/></button>
                          <button onClick={() => saveEdit(workout.id, ex.id)} className="p-1 text-green-600 hover:bg-green-50 rounded"><Check size={18}/></button>
                        </div>
                      </div>
                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="text-[10px] font-bold text-slate-400 uppercase">Sets</label>
                          <input type="number" value={editForm.sets} onChange={e => setEditForm({...editForm, sets: e.target.value})} className="w-full text-sm border rounded p-1" />
                        </div>
                        <div>
                          <label className="text-[10px] font-bold text-slate-400 uppercase">Rep Range</label>
                          <input type="text" value={editForm.range} onChange={e => setEditForm({...editForm, range: e.target.value})} className="w-full text-sm border rounded p-1" />
                        </div>
                        <div className="col-span-2">
                          <label className="text-[10px] font-bold text-slate-400 uppercase">Note</label>
                          <input type="text" value={editForm.note} onChange={e => setEditForm({...editForm, note: e.target.value})} className="w-full text-sm border rounded p-1" />
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Inputs */}
                <div className="p-2">
                  <div className="grid grid-cols-10 gap-2 text-[10px] font-bold text-slate-400 mb-2 px-2 text-center uppercase tracking-wider">
                    <div className="col-span-1">#</div>
                    <div className="col-span-4">Last Time</div>
                    <div className="col-span-5">Today</div>
                  </div>
                  
                  {Array.from({ length: ex.sets }).map((_, setIdx) => {
                    const lastLog = getLastLog(ex.id, setIdx);
                    const currentSet = currentSession[ex.id]?.[setIdx] || { weight: '', reps: '' };
                    
                    return (
                      <div key={setIdx} className="grid grid-cols-10 gap-2 items-center mb-2">
                        <div className="col-span-1 flex justify-center">
                          <div className="w-6 h-6 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-bold">
                            {setIdx + 1}
                          </div>
                        </div>
                        <div className="col-span-4 flex justify-center items-center bg-slate-50 rounded border border-slate-100 text-slate-400 text-xs h-9">
                          {lastLog ? (
                            <span>{lastLog.weight} <span className="text-[10px]">kg</span> × {lastLog.reps}</span>
                          ) : (
                            <span className="opacity-20">-</span>
                          )}
                        </div>
                        <div className="col-span-5 flex gap-1">
                          <input
                            type="number"
                            placeholder="kg"
                            className="w-full bg-white border border-slate-200 rounded py-1.5 text-center text-sm font-bold focus:border-blue-500 outline-none"
                            value={currentSet.weight}
                            onChange={(e) => handleInputChange(ex.id, setIdx, 'weight', e.target.value)}
                          />
                          <input
                            type="number"
                            placeholder="reps"
                            className="w-full bg-white border border-slate-200 rounded py-1.5 text-center text-sm font-bold focus:border-blue-500 outline-none"
                            value={currentSet.reps}
                            onChange={(e) => handleInputChange(ex.id, setIdx, 'reps', e.target.value)}
                          />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}
        </div>

        <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-slate-200 p-4 flex justify-center safe-area-pb z-20">
          <button
            onClick={handleFinishWorkout}
            className="bg-slate-900 text-white font-bold py-3 px-8 rounded-xl shadow-lg flex items-center gap-2 hover:bg-slate-800 active:scale-95 transition-all w-full max-w-xs justify-center"
          >
            <Save size={20} />
            Complete Session
          </button>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-white text-slate-900 font-sans selection:bg-blue-100">
      {view === 'home' && <HomeScreen />}
      {view === 'workout' && <WorkoutScreen />}
    </div>
  );
};

export default App;
